#!/usr/bin/env groovy
node('master') {
    def branchToBuild = 'master'
    def appDir = 'app'
    def performanceDir = appDir + '/performance-rest'

    def mvn = "${tool 'maven-3'}/bin/mvn".toString()

    try {

        stage('\u2780 Checkout') {
            echo "Branch ${branchToBuild} "
            dir(appDir) {
                git url: 'git@assembla.contactlab.com:platform-content-message.smart-send.git', branch: branchToBuild
                sh "git submodule init"
                sh "git submodule sync"
                sh "git submodule update --force --checkout"
            }
        }

        lock('smartsend-staging') {
            stage('\u2781 performance tests') {
                dir(performanceDir) {
                    sh "${mvn} -Pjmeter clean verify"
                }
            }
        }

        stage('\u2782 performance report') {
            dir(performanceDir) {
                perfReport modeThroughput: true, sourceDataFiles: '**/*.jtl'
            }
        }


        currentBuild.result = 'SUCCESS'
    } catch (exc) {
        currentBuild.result = 'FAILURE'
        // notifyBuild((String) currentBuild.result, "stage", branchToBuild)
        throw exc
    }
}

def notifyBuild(String buildStatus, String deployEnv, String branchToBuild) {

    final API_FAIL_WEBHOOK = 'https://outlook.office.com/webhook/ef926065-bec9-4f4f-886c-abafe5f90882@08566e73-0a0a-4754-b5e6-929162ec4325/IncomingWebhook/0a19fa97f2ef4a8496a6600a3c4baa4a/e33f0c86-0215-4fdb-8c24-db292803c76c'
    def teamsColorCode
    def webHook

    switch (buildStatus) {
        case 'STARTED':
            teamsColorCode = 'BDC3C7'
            break
        case 'SUCCESS':
            teamsColorCode = '2ECC71'
            break
        default:
            teamsColorCode = 'E74C3C'
            webHook = API_FAIL_WEBHOOK
    }

    // Build Microsoft Teams body
    def teamsBody = "{\"@type\": \"MessageCard\"," +
            "\"summary\": \"${env.JOB_NAME} [#${env.BUILD_NUMBER}]: Pipeline ${buildStatus}.\"," +
            "\"title\": \"Pipeline ${buildStatus}\"," +
            "\"themeColor\": \"${teamsColorCode}\"," +
            "\"sections\": [{\"facts\": [" +
            "{\"name\": \"Project:\"," +
            "\"value\": \"${env.JOB_NAME}\"}," +
            "{\"name\": \"Branch:\"," +
            "\"value\": \"${branchToBuild}\"}," +
            "{\"name\": \"Environment:\"," +
            "\"value\": \"${deployEnv}\"}]}]," +
            "\"potentialAction\": [{" +
            "\"@type\": \"ViewAction\"," +
            "\"name\": \"View in Jenkins\"," +
            "\"target\": [\"${env.BUILD_URL}\"]}]}"

    if (webHook) {
        //       sh "curl -H 'Content-Type: application/json' -d '${teamsBody}' ${webHook}"
    }

}